<!--
    SPDX-License-Identifier: AGPL-3.0-or-later
    Copyright (C) 2024 Aden Chan
    Copyright (C) 2024 Andrew Rechnitzer
    Copyright (C) 2025 Colin B. Macdonald
-->
{% extends "base/base.html" %}
{% load static %}
{% block title %}
    Master Reset
{% endblock title %}
{% block page_heading %}
    Master Reset
{% endblock page_heading %}
{% block main_content %}
    <div class="d-grid gap-2">
        <div>
            <a class="btn btn-primary" href="{% url 'prep_landing' %}">Return to assessment preparation page</a>
        </div>
        <div>
            <p>Do you want to completely reset this Plom instance?</p>
            {% if not have_spec %}
                <p>There is no assessment specification - so resetting probably won't do much.</p>
            {% elif bundles_staged %}
                <p>
                    <strong>Reset is not allowed:</strong>
                    This Plom instance has staged bundles and cannot be wiped via this interface.
                    Contact your server administrator if you truly need to reset this instance
                </p>
                <!-- (we also disable the buttons in the form below) -->
            {% else %}
                <p>
                    <strong>This action is irreversible and will completely delete any data stored</strong>
                </p>
                <p>All data stored by Plom currently will be wiped, including but not limited to:</p>
                <ul>
                    <li>The assessment specifications</li>
                    <li>All printable PDFs</li>
                    <li>The "QV map"</li>
                </ul>
            {% endif %}
        </div>
        <div class="accordion mt-3" id="reset_accordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="accordion_heading1">
                    <button class="accordion-button text-bg-danger collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse1"
                            aria-expanded="false"
                            aria-controls="collapse1">Continue to reset</button>
                </h2>
                <div id="collapse1"
                     class="accordion-collapse collapse"
                     aria-labelledby="accordion_heading1"
                     data-bs-parent="#reset_accordion">
                    <div class="accordion-body bg-danger-subtle">
                        <div class="row g-0">
                            <div class="col-md-auto">
                                <img class="img-fluid rounded-start"
                                     style="width: 25ex"
                                     src="{% static 'fingers_in_gears.svg' %}"
                                     alt="a warning graphic">
                            </div>
                            <div class="col-md">
                                <p>
                                    Confirm that you understand that this action is irreversible,
                                    will result in the complete loss of data on this Plom instance,
                                    and that you wish to continue anyway by entering the text below.
                                </p>
                                <div>
                                    <!-- this is the target for any htmx error messages -->
                                    <!-- p-0 border-0 here tries to hide the div when its empty -->
                                    <div id="my-errors" class="p-0 border-0 alert alert-danger"></div>
                                </div>
                                <form hx-post=""
                                      action=""
                                      hx-target="body"
                                      hx-confirm="Are you sure?"
                                      hx-target-error="#my-errors"
                                      hx-disabled-elt="#wipe_button"
                                      hx-indicator="#myindicator"
                                      autocomplete="off">
                                    {% csrf_token %}
                                    <div class="form-floating mb-3">
                                        <input type="text"
                                               name="reset_phrase_box"
                                               class="form-control"
                                               pattern="{{ reset_phrase }}"
                                               title="Enter {{ reset_phrase }} to continue"
                                               id="reset_phrase_box"
                                               placeholder="{{ reset_phrase }}"
                                               {% if bundles_staged %}disabled{% endif %}>
                                        <label for="reset_phrase_box">Enter &ldquo;{{ reset_phrase }}&rdquo; to continue</label>
                                    </div>
                                    <!-- hx-disabled-elt="self" on this button doesn't work b/c this button doesn't have hx-post -->
                                    <button type="submit"
                                            class="btn btn-danger"
                                            id="wipe_button"
                                            {% if bundles_staged %}disabled{% endif %}>
                                        <i class="bi bi-exclamation-triangle-fill"></i> Wipe Plom Instance
                                    </button>
                                    <span id="myindicator" class="htmx-indicator">
                                        <img src="{% static 'ball_triangle.svg' %}" />
                                        busy...
                                    </span>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock main_content %}
