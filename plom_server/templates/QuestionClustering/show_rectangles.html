<!--
    SPDX-License-Identifier: AGPL-3.0-or-later
    Copyright (C) 2025 Bryan Tanady
-->
{% extends "base/base.html" %}
{% load static %}
{% block title %}
    Rectangles from v {{ version }} p {{ page_num }}
{% endblock title %}
{% block page_heading %}
    Rectangles from v {{ version }} p {{ page_num }}
{% endblock page_heading %}
{% block main_content %}
    <div>
        <a class="btn btn-success" href="{% url 'question_clustering_home' %}">
            <i class="bi bi-chevron-left"></i>
            Return to choose version/question
        </a>
    </div>
    <div class="card m-2">
        <div class="card-body">
            <h5 class="card-title">Preview of extracted rectangles for Version {{ version }} page {{ page_num }}</h5>

            <!-- Button that pops up the clustering model dialog -->
            <button 
                type="submit"
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#modelSelectionModal">
                Begin clustering
            </button>

            <!-- The modal dialog for choosing clustering model -->
            <div
                class="modal fade"
                id="modelSelectionModal"
                tabindex="-1"
                aria-labelledby="modelSelectionModalLabel"
                aria-hidden="true">

                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modelSelectionModalLabel">
                                Choose answer type for clustering.
                            </h5>

                             <button
                                type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close">
                            </button>
                        </div>

                            <form method="post">
                                {% csrf_token %}
                                <div class="modal-body">

                                    <!-- Render hidden inputs-->
                                    {% for hidden in clustering_job_form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}

                                    {% for radio in clustering_job_form.choice %}
                                        <div class="form-check">
                                            {{ radio.tag }}
                                            <label
                                            class="form-check-label"
                                            for="{{ radio.id_for_label }}"
                                            >
                                            {{ radio.choice_label }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                    {% if clustering_job_form.choice.errors %}
                                        <div class="text-danger small mt-2">
                                            {{ clustering_job_form.choice.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>

                                <div class="modal-footer">
                                    <button
                                    type="button"
                                    class="btn btn-secondary"
                                    data-bs-dismiss="modal"
                                    >
                                    Cancel
                                    </button>
                                    <button type="submit" class="btn btn-primary">Submit</button>
                                </div>
                            </form>
                    </div>
                </div>
            </div>


            <!-- </form> -->
            {% if papers %}
                <p>
                    <ul>
                        <div class="container">
                            <div class="row">
                                {% for pn in papers %}
                                    <div class="col-6 mb-4">
                                        <strong>Paper {{ pn }}:</strong>
                                        <br />
                                        <img class="img-fluid border p-2"
                                             src="{% url 'extracted_rectangle' pn version page_num %}?left={{ left }}&top={{ top }}&right={{ right }}&bottom={{ bottom }}"
                                             onerror="imgError(this)" />
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </ul>
                </p>
            {% else %}
                <p>
                    There are no papers with version {{ version }} of page {{ page_num }}. This could be because
                    <ul>
                        <li>You have not finished uploading scans</li>
                        <li>
                            Your test specification, or question-version map, may not allow page {{ page_num }} to be chosen from version {{ version }}
                        </li>
                    </ul>
                </p>
            {% endif %}
        </div>
    </div>
    <script type="text/javascript">
  function imgError(image) {
    var img_error_span = document.createElement('span');
    img_error_span.classList.add("alert", "alert-warning", "mx-2", "py-0");
    img_error_span.innerHTML = "Could not extract rectangle.";

    image.parentNode.insertBefore(img_error_span, image);
    image.parentNode.removeChild(image);
  }
    </script>
{% endblock main_content %}
