<!--
    SPDX-License-Identifier: AGPL-3.0-or-later
    Copyright (C) 2023 Brennen Chiu
    Copyright (C) 2023-2025 Colin B. Macdonald
    Copyright (C) 2024 Bryan Tanady
    Copyright (C) 2024 Elisa Pan
    Copyright (C) 2025 Aidan Murphy
-->
{% extends "base/base.html" %}
{% load static %}
{% block title %}
    Marker progress and quotas
{% endblock title %}
{% block page_heading %}
    Marker progress and quotas
{% endblock page_heading %}
{% block main_content %}
    <div class="card my-2">
        <div class="card-body">
            <h5>Default quota limit: {{ default_quota_limit }}</h5>
            <button class="btn btn-primary"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#modifyDefaultLimit">Change default limit</button>
            {% if messages %}
                <div>
                    {% for message in messages %}
                        {% if 'modify_default_limit' in message.tags %}
                            {% include "../../base/alert_message.html" with message=message %}
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
    <div class="card w-100">
        <div class="card-body d-flex flex-wrap gap-2">
            <button class="btn btn-primary"
                    type="button"
                    data-bs-toggle="modal"
                    data-bs-target="#modifyQuotaModal">Modify quota limit</button>
            <form action="{% url 'bulk_set_quota' %}"
                  method="post"
                  style="display:inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Set Quota for All Markers</button>
            </form>
            <form action="{% url 'bulk_unset_quota' %}"
                  method="post"
                  style="display:inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-secondary">Unset Quota for All Markers</button>
            </form>
            <a class="btn btn-link" href="{% url 'users' %}">User account management</a>
        </div>
        <div class="card-body">
            <div>
                <i class="bi bi-exclamation-diamond-fill text-info"></i>
                {{ users_with_quota_count }} markers have quotas.
            </div>
            {% if messages %}
                <div>
                    {% for message in messages %}
                        {% if 'modify_quota' in message.tags %}
                            {% include "../../base/alert_message.html" with message=message %}
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
    <div class="table-responsive">
        <table class="table text-center align-middle sortable">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Task Marked</th>
                    <th>Task Claimed</th>
                    <th>Quota Limit</th>
                    <th>Quota Tasks</th>
                </tr>
            </thead>
            <tbody>
                {% for username, progress in users_progress.items %}
                    <tr class="{% if progress.quota_limit == progress.tasks_marked %} table-success {% endif %}">
                        <td>
                            {{ username }}
                            {% if messages %}
                                {% for message in messages %}
                                    {% if 'quota_warning' in message.tags and progress.would_exceed_default_limit %}
                                        <i class="bi bi-exclamation-triangle-fill text-warning"
                                           data-bs-toggle="modal"
                                           data-bs-target="#confirmSetQuota"
                                           data-username="{{ username }}"></i>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            {% if progress.has_quota_limit %}
                                <i class="bi bi-exclamation-diamond-fill text-info"
                                   data-bs-toggle="tooltip"
                                   title="Quota limited"></i>
                            {% endif %}
                        </td>
                        <td>{{ progress.tasks_marked }}</td>
                        <td>{{ progress.tasks_claimed }}</td>
                        <!-- really need custom key here, Issue #4026 -->
                        <td sorttable_customkey={{ progress.quota_limit_or_zero }}>
                            {% if progress.has_quota_limit %}
                                {{ progress.quota_limit }}
                                <button class="btn btn-outline-primary ms-1"
                                        type="button"
                                        data-bs-toggle="modal"
                                        data-username="{{ username }}"
                                        data-limit="{{ progress.quota_limit }}"
                                        data-bs-target="#editLimit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <form action="{% url 'unset_quota' username %}"
                                      style="display:inline"
                                      method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-secondary">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            {% else %}
                                <form action="{% url 'set_quota' username %}"
                                      style="display:inline"
                                      method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-primary">Enable</button>
                                </form>
                            {% endif %}
                        </td>
                        <td>
                            <!-- TODO: hardcoded tag here, must match question_marking.py -->
                            <a class="btn btn-primary"
                               href="{% url 'progress_marking_task_filter' %}?username={{ username }}&the_tag=during_quota">
                                view
                            </a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <hr />
    <div class="mb-3">
        <form method="get" action="">
            <div>
                <h6>
                    <b>Filter annotations by time:</b>
                </h6>
                <p>{{ annotation_filter_form.time_filter_seconds.label }} {{ annotation_filter_form.time_filter_seconds }}</p>
                <p class="text-danger">{{ error }}</p>
            </div>
            <button type="submit" class="btn btn-primary">Filter</button>
        </form>
    </div>
    <div class="mb-3">
        <p>
            <b>Latest Updated Annotation: {{ latest_updated_annotation_human_time }}</b>
        </p>
    </div>
    <div class="table-responsive">
        <table class="table text-center align-middle sortable">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Question</th>
                    <th>Version</th>
                    <th>Annotation Count</th>
                    <th>Average Marking Time</th>
                    <th>Percentage Marked</th>
                </tr>
            </thead>
            <tbody>
                {% for username, annotations in annotations_grouped_by_user.items %}
                    {% for data in annotations %}
                        <tr>
                            <td>{{ username }}</td>
                            <td>{{ data.question_label_html|safe }}</td>
                            <td>{{ data.question_version }}</td>
                            <td>{{ data.annotations_count }}</td>
                            <td sorttable_customkey={{ data.average_marking_time_sort_key_hack }}>
                                {{ data.average_marking_time }}
                            </td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar"
                                         role="progressbar"
                                         style="width: {{ data.percentage_marked }}%"
                                         aria-valuenow="{{ data.percentage_marked }}"
                                         aria-valuemin="0"
                                         aria-valuemax="100">{{ data.percentage_marked }}%</div>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Hidden element to pass message data and username -->
    <div id="messages"
         data-message-type="{% if messages %}{% for message in messages %}{{ message.tags }}{% endfor %}{% endif %}"
         data-message-text="{% if messages %}{% for message in messages %}{{ message.message }}{% endfor %}{% endif %}"
         data-username="{{ username }}"></div>
    {% include "./modal_forms.html" %}
    <script src="{% static 'js3rdparty/jquery-3.6.4.min.js' %}"
            integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8="></script>
    <script src="{% static 'js3rdparty/select2.min.js' %}"></script>
    <link href="{% static 'css3rdparty/select2.min.css' %}" rel="stylesheet" />
    <script>
        $('#editLimit').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var username = button.data('username');
            var limit = button.data('limit');
            var modal = $(this);

            modal.find('.modal-title').text('Edit Limit for ' + username);
            modal.find('input[name="username"]').val(username);
            modal.find('input[name="limit"]').val(limit);
        });
    </script>
    <script>
        $(document).ready(function() {
            $('.select2').select2();
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to show the modal and set the form action URL
            function showModalWithUsername(username) {
                var form = document.getElementById('confirmSetQuotaForm');
                var actionUrl = "{% url 'set_quota' 'username_placeholder' %}".replace('username_placeholder', username);
                form.action = actionUrl;
                $('#confirmSetQuota').modal('show');
            }

            // Check for messages and handle the modal
            var messages = document.getElementById('messages');
            if (messages) {
                var messageType = messages.getAttribute('data-message-type');
                var messageText = messages.getAttribute('data-message-text');
                var details = JSON.parse(messageText);
                var username = details.username;

                if (messageType.includes('set_quota_confirmation')) {
                    showModalWithUsername(username);
                }
            }
        });
    </script>
    <style>
        .select2-container {
            z-index: 9999;
        }
    </style>
{% endblock main_content %}
